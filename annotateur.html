<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Annotateur d'image ‚Äì Labo virtuel</title>
    <!-- Tailwind Play CDN (no build needed) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React 18 UMD + Babel for in-browser JSX transform -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  </head>
  <body class="bg-slate-50">
    <div id="root"></div>

    <script type="text/babel">
      const { useEffect, useMemo, useRef, useState } = React;

      // --- Utilitaires ---
      function uid() {
        return Math.random().toString(36).slice(2, 9);
      }

      const DEFAULT_CATEGORIES = [
        "S√©curit√©",
        "Propret√©",
        "√âlectrique",
        "Chimique",
        "Ergonomie",
        "Autre",
      ];

      function VirtualLabAnnotator() {
        const [imageSrc, setImageSrc] = useState(null);
        const [imgNatural, setImgNatural] = useState(null);
        const [annotations, setAnnotations] = useState([]);
        const [mode, setMode] = useState("pin");
        const [isDrawing, setIsDrawing] = useState(false);
        const [draftBox, setDraftBox] = useState(null);
        const [zoom, setZoom] = useState(1);
        const [offset, setOffset] = useState({ x: 0, y: 0 });
        const [panning, setPanning] = useState(false);
        const panStartRef = useRef(null);
        const containerRef = useRef(null);
        const imgRef = useRef(null);
        const [selectedId, setSelectedId] = useState(null);

        // Lecture fichier image
        const onImageUpload = (file) => {
          const reader = new FileReader();
          reader.onload = (e) => setImageSrc(e.target?.result);
          reader.readAsDataURL(file);
        };

        const onJsonImport = (file) => {
          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              const data = JSON.parse(String(e.target?.result || "{}"));
              if (data && data.annotations && Array.isArray(data.annotations)) {
                setAnnotations(data.annotations);
              }
              if (data && data.imageSrc) setImageSrc(data.imageSrc);
            } catch (err) {
              alert("Fichier JSON invalide");
            }
          };
          reader.readAsText(file);
        };

        const exportJSON = () => {
          const data = {
            imageSrc,
            annotations,
            meta: {
              exportedAt: new Date().toISOString(),
              naturalSize: imgNatural,
            },
          };
          const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "annotations_labo.json";
          a.click();
          URL.revokeObjectURL(url);
        };

        const onImgLoad = (e) => {
          const img = e.currentTarget;
          setImgNatural({ w: img.naturalWidth, h: img.naturalHeight });
        };

        // Conversion: position √©cran -> position % image source
        const clientToImagePercent = (clientX, clientY) => {
          if (!containerRef.current || !imgNatural) return { xPct: 0, yPct: 0 };
          const bounds = containerRef.current.getBoundingClientRect();
          // tenir compte du pan & zoom
          const xInView = (clientX - bounds.left - offset.x);
          const yInView = (clientY - bounds.top - offset.y);
          const xImg = xInView / zoom;
          const yImg = yInView / zoom;
          const xPct = Math.max(0, Math.min(100, (xImg / imgNatural.w) * 100));
          const yPct = Math.max(0, Math.min(100, (yImg / imgNatural.h) * 100));
          return { xPct, yPct };
        };

        // Conversion: % image -> coords SVG (dans rep√®re image naturelle)
        const pctToSvg = (pct, dim) => (pct / 100) * dim;

        const handleCanvasClick = (e) => {
          if (!imgNatural || !imageSrc) return;
          if (mode === "pin") {
            const { xPct, yPct } = clientToImagePercent(e.clientX, e.clientY);
            const ann = {
              id: uid(),
              type: "pin",
              x: xPct,
              y: yPct,
              label: "",
              category: DEFAULT_CATEGORIES[0],
            };
            setAnnotations((a) => [...a, ann]);
            setSelectedId(ann.id);
          }
        };

        const handleMouseDown = (e) => {
          if (!imgNatural || !imageSrc) return;

          if (mode === "box") {
            setIsDrawing(true);
            const { xPct, yPct } = clientToImagePercent(e.clientX, e.clientY);
            setDraftBox({ x1: xPct, y1: yPct, x2: xPct, y2: yPct });
          }

          if (mode === "pan") {
            setPanning(true);
            panStartRef.current = { x: e.clientX - offset.x, y: e.clientY - offset.y };
          }
        };

        const handleMouseMove = (e) => {
          if (!imgNatural || !imageSrc) return;

          if (isDrawing && mode === "box" && draftBox) {
            const { xPct, yPct } = clientToImagePercent(e.clientX, e.clientY);
            setDraftBox({ ...draftBox, x2: xPct, y2: yPct });
          }

          if (panning && mode === "pan" && panStartRef.current) {
            const nx = e.clientX - panStartRef.current.x;
            const ny = e.clientY - panStartRef.current.y;
            setOffset({ x: nx, y: ny });
          }
        };

        const handleMouseUp = (e) => {
          if (!imgNatural || !imageSrc) return;

          if (isDrawing && mode === "box" && draftBox) {
            const b = normalizeBox(draftBox);
            const ann = {
              id: uid(),
              type: "box",
              x1: b.x1,
              y1: b.y1,
              x2: b.x2,
              y2: b.y2,
              label: "",
              category: DEFAULT_CATEGORIES[0],
            };
            setAnnotations((a) => [...a, ann]);
            setSelectedId(ann.id);
            setDraftBox(null);
            setIsDrawing(false);
          }

          if (panning && mode === "pan") {
            setPanning(false);
            panStartRef.current = null;
          }
        };

        const normalizeBox = (b) => {
          const x1 = Math.min(b.x1, b.x2);
          const y1 = Math.min(b.y1, b.y2);
          const x2 = Math.max(b.x1, b.x2);
          const y2 = Math.max(b.y1, b.y2);
          return { x1, y1, x2, y2 };
        };

        const updateAnnotation = (id, patch) => {
          setAnnotations((prev) => prev.map((a) => (a.id === id ? { ...a, ...patch } : a)));
        };

        const deleteAnnotation = (id) => {
          setAnnotations((prev) => prev.filter((a) => a.id !== id));
          if (selectedId === id) setSelectedId(null);
        };

        const resetView = () => {
          setZoom(1);
          setOffset({ x: 0, y: 0 });
        };

        const imageLoaded = Boolean(imageSrc && imgNatural);

        return (
          <div className="min-h-screen w-full bg-slate-50 text-slate-800">
            <header className="sticky top-0 z-20 border-b bg-white/70 backdrop-blur">
              <div className="mx-auto flex max-w-6xl items-center gap-3 p-3">
                <h1 className="text-xl font-semibold">Annotateur d'image ‚Äì Labo virtuel</h1>
                <div className="ml-auto flex items-center gap-2">
                  <label className="inline-flex cursor-pointer items-center gap-2 rounded-xl border px-3 py-2 text-sm shadow-sm hover:bg-slate-50">
                    <input
                      type="file"
                      accept="image/*"
                      className="hidden"
                      onChange={(e) => e.target.files?.[0] && onImageUpload(e.target.files[0])}
                    />
                    üì∑ Charger une image
                  </label>

                  <label className="inline-flex cursor-pointer items-center gap-2 rounded-xl border px-3 py-2 text-sm shadow-sm hover:bg-slate-50">
                    <input
                      type="file"
                      accept="application/json"
                      className="hidden"
                      onChange={(e) => e.target.files?.[0] && onJsonImport(e.target.files[0])}
                    />
                    ‚§µÔ∏è Import JSON
                  </label>

                  <button
                    onClick={exportJSON}
                    disabled={!annotations.length}
                    className="rounded-xl border px-3 py-2 text-sm shadow-sm hover:bg-slate-50 disabled:cursor-not-allowed disabled:opacity-50"
                  >
                    ‚§¥Ô∏è Export JSON
                  </button>
                </div>
              </div>
            </header>

            <main className="mx-auto grid max-w-6xl grid-cols-12 gap-4 p-4">
              {/* Panneau gauche: outils */}
              <section className="col-span-12 md:col-span-3 flex flex-col gap-3">
                <div className="rounded-2xl border bg-white p-3 shadow-sm">
                  <div className="mb-2 text-sm font-medium">Outils</div>
                  <div className="grid grid-cols-3 gap-2">
                    <button
                      onClick={() => setMode("pin")}
                      className={`rounded-xl border px-3 py-2 text-sm ${mode === "pin" ? "bg-slate-900 text-white" : "hover:bg-slate-50"}`}
                    >
                      üìç Pin
                    </button>
                    <button
                      onClick={() => setMode("box")}
                      className={`rounded-xl border px-3 py-2 text-sm ${mode === "box" ? "bg-slate-900 text-white" : "hover:bg-slate-50"}`}
                    >
                      ‚ñ≠ Zone
                    </button>
                    <button
                      onClick={() => setMode("pan")}
                      className={`rounded-xl border px-3 py-2 text-sm ${mode === "pan" ? "bg-slate-900 text-white" : "hover:bg-slate-50"}`}
                    >
                      ‚úã D√©placer
                    </button>
                  </div>

                  <div className="mt-3 flex items-center gap-3">
                    <label className="text-sm">Zoom</label>
                    <input
                      type="range"
                      min={0.5}
                      max={3}
                      step={0.1}
                      value={zoom}
                      onChange={(e) => setZoom(parseFloat(e.target.value))}
                    />
                    <button onClick={resetView} className="rounded-lg border px-2 py-1 text-xs hover:bg-slate-50">R√©initialiser</button>
                  </div>
                </div>

                <div className="rounded-2xl border bg-white p-3 shadow-sm">
                  <div className="mb-2 text-sm font-medium">Annotations ({annotations.length})</div>
                  <div className="flex max-h-[50vh] flex-col gap-2 overflow-auto pr-1">
                    {annotations.map((a, idx) => (
                      <div
                        key={a.id}
                        className={`rounded-xl border p-2 text-sm ${selectedId === a.id ? "ring-2 ring-slate-900" : ""}`}
                        onClick={() => setSelectedId(a.id)}
                      >
                        <div className="mb-2 flex items-center justify-between">
                          <span className="font-medium">{a.type === 'pin' ? 'üìç' : '‚ñ≠'} #{idx + 1}</span>
                          <button
                            className="rounded-lg border px-2 py-1 text-xs hover:bg-red-50"
                            onClick={(e) => { e.stopPropagation(); deleteAnnotation(a.id); }}
                          >
                            Supprimer
                          </button>
                        </div>
                        <div className="mb-2 grid grid-cols-4 items-center gap-2">
                          <label className="col-span-1 text-xs text-slate-600">Cat√©gorie</label>
                          <select
                            className="col-span-3 rounded-lg border px-2 py-1"
                            value={a.category}
                            onChange={(e) => updateAnnotation(a.id, { category: e.target.value })}
                          >
                            {DEFAULT_CATEGORIES.map((c) => (
                              <option key={c} value={c}>{c}</option>
                            ))}
                          </select>

                          <label className="col-span-1 text-xs text-slate-600">Label</label>
                          <input
                            className="col-span-3 rounded-lg border px-2 py-1"
                            value={a.label}
                            placeholder="Ex: Bidon ouvert √† c√¥t√© de la balance"
                            onChange={(e) => updateAnnotation(a.id, { label: e.target.value })}
                          />
                        </div>
                        <div className="text-xs text-slate-500">
                          {a.type === 'pin'
                            ? `x=${a.x?.toFixed(1)}% ¬∑ y=${a.y?.toFixed(1)}%`
                            : `x1=${a.x1?.toFixed(1)}% ¬∑ y1=${a.y1?.toFixed(1)}% ¬∑ x2=${a.x2?.toFixed(1)}% ¬∑ y2=${a.y2?.toFixed(1)}%`}
                        </div>
                      </div>
                    ))}

                    {!annotations.length && (
                      <div className="rounded-xl border border-dashed p-3 text-center text-sm text-slate-500">
                        Aucune annotation. Choisissez un mode (üìç ou ‚ñ≠) puis cliquez sur l'image.
                      </div>
                    )}
                  </div>

                  {annotations.length > 0 && (
                    <div className="mt-3 text-right">
                      <button
                        className="rounded-xl border px-3 py-2 text-sm hover:bg-slate-50"
                        onClick={() => setAnnotations([])}
                      >
                        Tout effacer
                      </button>
                    </div>
                  )}
                </div>
              </section>

              {/* Zone centrale: image + overlay */}
              <section className="col-span-12 md:col-span-9">
                <div className="rounded-2xl border bg-white p-3 shadow-sm">
                  {!imageSrc && (
                    <div className="flex h-[70vh] items-center justify-center rounded-xl border border-dashed">
                      <div className="text-center">
                        <p className="text-sm text-slate-500">Charge une photo de ton labo (d√©sordre, probl√®mes √† identifier)</p>
                        <div className="mt-3">
                          <label className="inline-flex cursor-pointer items-center gap-2 rounded-xl border px-3 py-2 text-sm shadow-sm hover:bg-slate-50">
                            <input
                              type="file"
                              accept="image/*"
                              className="hidden"
                              onChange={(e) => e.target.files?.[0] && onImageUpload(e.target.files[0])}
                            />
                            üì∑ Charger une image
                          </label>
                        </div>
                      </div>
                    </div>
                  )}

                  {imageSrc && (
                    <div
                      ref={containerRef}
                      className="relative h-[70vh] w-full overflow-hidden rounded-xl border bg-slate-100"
                      onClick={handleCanvasClick}
                      onMouseDown={handleMouseDown}
                      onMouseMove={handleMouseMove}
                      onMouseUp={handleMouseUp}
                    >
                      {/* Vue image + overlay dans un groupe transform√© (pan+zoom) */}
                      <div
                        className="absolute left-0 top-0 origin-top-left"
                        style={{ transform: `translate(${offset.x}px, ${offset.y}px) scale(${zoom})` }}
                      >
                        <img
                          ref={imgRef}
                          src={imageSrc}
                          onLoad={onImgLoad}
                          alt="Labo"
                          className="select-none pointer-events-none"
                          draggable={false}
                          style={{ display: imgNatural ? 'block' : 'none' }}
                        />

                        {imgNatural && (
                          <svg
                            width={imgNatural.w}
                            height={imgNatural.h}
                            viewBox={`0 0 ${imgNatural.w} ${imgNatural.h}`}
                            className="absolute left-0 top-0"
                          >
                            {/* Zones (box) existantes */}
                            {annotations.filter(a => a.type === 'box').map((a) => {
                              const x = pctToSvg(a.x1, imgNatural.w);
                              const y = pctToSvg(a.y1, imgNatural.h);
                              const w = pctToSvg((a.x2 - a.x1), imgNatural.w);
                              const h = pctToSvg((a.y2 - a.y1), imgNatural.h);
                              const selected = selectedId === a.id;
                              return (
                                <g key={a.id}>
                                  <rect
                                    x={x}
                                    y={y}
                                    width={w}
                                    height={h}
                                    fill={selected ? "rgba(15,23,42,0.15)" : "rgba(15,23,42,0.10)"}
                                    stroke={selected ? "rgba(15,23,42,0.9)" : "rgba(15,23,42,0.7)"}
                                    strokeWidth={2}
                                  />
                                  <text x={x + 6} y={y + 18} fontSize={14} fill="#0f172a">
                                    {a.label || a.category}
                                  </text>
                                </g>
                              );
                            })}

                            {/* Zone en cours de dessin */}
                            {draftBox && imgNatural && (() => {
                              const b = normalizeBox(draftBox);
                              const x = pctToSvg(b.x1, imgNatural.w);
                              const y = pctToSvg(b.y1, imgNatural.h);
                              const w = pctToSvg((b.x2 - b.x1), imgNatural.w);
                              const h = pctToSvg((b.y2 - b.y1), imgNatural.h);
                              return (
                                <rect x={x} y={y} width={w} height={h} fill="rgba(99,102,241,0.15)" stroke="rgba(99,102,241,0.9)" strokeWidth={2} />
                              );
                            })()}

                            {/* Pins existants */}
                            {annotations.filter(a => a.type === 'pin').map((a) => {
                              const cx = pctToSvg(a.x, imgNatural.w);
                              const cy = pctToSvg(a.y, imgNatural.h);
                              const selected = selectedId === a.id;
                              return (
                                <g key={a.id}>
                                  <circle cx={cx} cy={cy} r={8} fill={selected ? "#0f172a" : "#334155"} />
                                  <circle cx={cx} cy={cy} r={12} fill="rgba(15,23,42,0.15)" />
                                  <text x={cx + 10} y={cy - 10} fontSize={14} fill="#0f172a" stroke="#ffffff" strokeWidth={0.5}>
                                    {a.label || a.category}
                                  </text>
                                </g>
                              );
                            })}
                          </svg>
                        )}
                      </div>

                      {/* Aide contextuelle */}
                      <div className="pointer-events-none absolute left-3 top-3 rounded-xl bg-white/80 p-2 text-xs shadow">
                        {mode === 'pin' && <div>Mode üìç : cliquez pour placer un rep√®re</div>}
                        {mode === 'box' && <div>Mode ‚ñ≠ : cliquer-glisser pour dessiner une zone</div>}
                        {mode === 'pan' && <div>Mode ‚úã : cliquer-glisser pour d√©placer la vue</div>}
                      </div>
                    </div>
                  )}
                </div>
              </section>
            </main>

            <footer className="mx-auto mt-2 max-w-6xl p-3 text-center text-xs text-slate-500">
              <a href="index.html" >Retour</a>
            </footer>
          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<VirtualLabAnnotator />);
    </script>
  </body>
</html>